#!/bin/bash
# set -ex

change_install_name() {
  files=$1
  dir=$2
  count=0
  echo "Changing install_name of $2 ..."

  for target in $files; do
    if [[ -n $(otool -L $target | sed -n '2,$p' | grep ${dir}) ]]; then
      echo '**********************************************************************'
      otool -L $target

      chmod +w $target
      keyvals=$(otool -L $target | sed -n '2,$p' | grep ${dir} | awk '{print $1}' | sed -E "s|$dir/(.*)|\0 \1|")
      echo $keyvals
      IFS=$'\n'
      for kv in ${keyvals}; do
        key=$(echo $kv | cut -d' ' -f1)
        val=$(echo $kv | cut -d' ' -f2)
        install_name_tool -change ${key} @rpath/${val} $target
      done
      install_name_tool -id @rpath/$(basename ${target}) $target
      unset IFS

      count=$((count + 1))

      echo '============================================='
      otool -L $target
      echo; echo; echo
    fi
  done

  echo $count
}
add_rpath() {
  echo "Adding RPATH ..."
  files=$1
  rpath=$2

  for target in $files; do
      chmod +w $target
      [[ `otool -l $target | grep $rpath` ]] && install_name_tool -delete_rpath $rpath $target
      install_name_tool -add_rpath $rpath $target
  done
}


echo "Checking file list ..."
bin_files=
for file in $(find /usr/local/hawq/bin -type f -name '*') $(find /usr/local/hawq/lib -type f -name '*') $(find /opt/dependency-Darwin/package/bin -type f -name '*'); do
  if [[ $(file $file | grep Mach-O) ]]; then
    # echo $file
    bin_files="$file $bin_files"
  fi
done
lib_files=$(find /opt/dependency*/package/lib -type f -name *.dylib -o -name *.so)

add_rpath "$bin_files" /usr/local/opt/oushudb/lib
add_rpath "$lib_files" /usr/local/opt/oushudb/lib

change_install_name "$bin_files" /usr/local/hawq/lib
change_install_name "$bin_files" /opt/dependency-Darwin/package/lib
change_install_name "$bin_files" /opt/dependency-Darwin/package//lib

change_install_name "$lib_files" /usr/local/hawq/lib
change_install_name "$lib_files" /opt/dependency-Darwin/package/lib
change_install_name "$lib_files" /opt/dependency-Darwin/package//lib
